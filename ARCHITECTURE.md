# Архитектура Telegram-бота для расписания

## Схема работы системы

```
┌─────────────────────────────────────────────────────────────────┐
│                        TELEGRAM BOT                              │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   /start     │  │  Сегодня     │  │  Настройки   │          │
│  │   Помощь     │  │  Завтра      │  │  Профиль     │          │
│  │              │  │  Пн-Сб       │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│         │                  │                  │                  │
│         └──────────────────┴──────────────────┘                 │
│                            │                                     │
└────────────────────────────┼─────────────────────────────────────┘
                             │
                   ┌─────────▼──────────┐
                   │    HANDLERS        │
                   │  - common.py       │
                   │  - schedule_viewer │
                   └─────────┬──────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
    ┌─────────▼─────────┐        ┌─────────▼──────────┐
    │    DATABASE       │        │      PARSER        │
    │   (SQLite)        │        │  - Загрузка XLSX   │
    │                   │        │  - Парсинг данных  │
    │ ┌───────────────┐ │        │  - Calamine/XML    │
    │ │    users      │ │        └─────────┬──────────┘
    │ │   schedule    │ │                  │
    │ │ schedule_files│ │                  │
    │ └───────────────┘ │         ┌────────▼────────┐
    └───────────────────┘         │  pkeu.ru/...    │
              │                   │  (XLSX файлы)   │
              │                   └─────────────────┘
    ┌─────────▼──────────┐
    │     SCHEDULER      │
    │                    │
    │ Задачи:            │
    │ • Проверка (20мин) │
    │ • Утро 7:30 (1,3к) │
    │ • Утро 10:00 (2к)  │
    │ • Вечер 20:00      │
    │ • Очистка 3:00     │
    └────────────────────┘
```

## Поток данных

### 1. Регистрация пользователя
```
Пользователь → /start 
              → Выбор базы (9/11 классов)
              → Выбор курса (1-4)
              → Выбор группы
              → Сохранение в БД
              → Главное меню
```

### 2. Просмотр расписания
```
Пользователь → "Сегодня"/"Завтра"/"Понедельник"...
              → Database.get_schedule_for_group()
              → Форматирование расписания
              → Отправка пользователю
```

### 3. Обновление расписания
```
Scheduler (каждые 20 мин)
    → parser.download_latest_schedule_file()
    → Проверка хэша файла
    → Если новый файл:
        → Парсинг (Calamine/XML)
        → Извлечение данных (группы, пары, время...)
        → Сохранение в Database
        → Сравнение со старым расписанием
        → Если есть изменения:
            → Уведомление пользователей
```

### 4. Уведомления
```
Scheduler (по расписанию)
    → Утром (7:30 или 10:00):
        → Database.get_users_with_notifications()
        → Фильтр по курсу
        → Для каждого пользователя:
            → Получить расписание на сегодня
            → Отправить уведомление
    
    → Вечером (20:00):
        → Для каждого пользователя:
            → Получить расписание на завтра
            → Отправить уведомление
```

## Структура базы данных

### Таблица: users
```sql
user_id INTEGER PRIMARY KEY
full_name TEXT
username TEXT
education_form TEXT           -- '9_classes' или '11_classes'
course INTEGER                -- 1, 2, 3, 4
group_name TEXT              -- 'Б1-24', 'ТД-25' и т.д.
notify_lessons BOOLEAN       -- Уведомления о парах
notify_changes BOOLEAN       -- Уведомления об изменениях
notify_new_schedule BOOLEAN  -- Уведомления о новом расписании
```

### Таблица: schedule
```sql
id INTEGER PRIMARY KEY
group_name TEXT              -- 'Б1-24'
day_of_week TEXT            -- 'понедельник', 'вторник'...
date TEXT                   -- '13.11.2025'
lesson_number TEXT          -- 'I', 'II', 'III'...
time_start TEXT             -- '08:30'
time_end TEXT               -- '10:05'
subject TEXT                -- 'Математика'
teacher TEXT                -- 'Иванов И.И.'
cabinet TEXT                -- '123'
file_hash TEXT              -- SHA256 файла
```

### Таблица: schedule_files
```sql
id INTEGER PRIMARY KEY
file_name TEXT
file_hash TEXT UNIQUE
created_at DATETIME         -- Для очистки старых файлов
```

## Логика определения курса

Курс определяется по году в названии группы:

```python
# Для группы "Б1-24":
year_from_group = 24
current_year = 25  # 2025 год
course = current_year - year_from_group + (1 if сентябрь_или_позже else 0)
# course = 25 - 24 + 1 = 2 курс (если после сентября)
```

## Форматы групп

### База 9 классов
- Формат: `[Буквы][Цифра]-[Год]`
- Примеры: `Б1-24`, `Д2-23`, `Ю3-25`
- Листы в XLSX: "1 курс", "2 курс", "3 курс"

### База 11 классов
- Формат: `[Буквы]-[Год]`
- Примеры: `БУ-25`, `ТД-24`, `Ю-25`
- Листы в XLSX: "1 курс", "2 курс"

## Безопасность

- ✅ Токен бота в `.env` (не в коде)
- ✅ База данных локальная (SQLite)
- ✅ Нет хранения паролей
- ✅ Обработка ошибок и исключений
- ✅ Валидация входных данных
